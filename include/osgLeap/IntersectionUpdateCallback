/*
* Library osgLeap
* Copyright (C) 2013 Johannes Scholz/vtxtech. All rights reserved.
*
* This file is licensed under the GNU Lesser General Public License 3 (LGPLv3),
* but distributed WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
*
*/

#ifndef OSGLEAP_INTERSECTIONUPDATECALLBACK_
#define OSGLEAP_INTERSECTIONUPDATECALLBACK_ 1

//-- Project --//
#include <osgLeap/Export>
#include <osgLeap/IntersectionController>

//-- OSG: osg --//
#include <osg/Camera>
#include <osg/Geode>
#include <osg/NodeCallback>

namespace osgLeap {

    class OSGLEAP_EXPORT IntersectionUpdateCallback: public osg::NodeCallback
    {
    public:
        typedef std::map<int, osg::ref_ptr<osg::PositionAttitudeTransform> > PatMap;
        typedef std::pair<int, osg::ref_ptr<osg::PositionAttitudeTransform> > PatPair;

        // Parameter-constructor with fixed screen resolution
        // Use setResolution to update during runtime
        IntersectionUpdateCallback(int screenwidth, int screenheight): camera_(NULL),
            intersectionController_(new osgLeap::IntersectionController()), colorIndex_(0),
            screenwidth_(screenwidth), screenheight_(screenheight)
        {

        }

        // Parameter-constructor with auto-update to screen resolution
        IntersectionUpdateCallback(osg::Camera* camera): camera_(camera),
            intersectionController_(new osgLeap::IntersectionController()), colorIndex_(0),
            screenwidth_(800), screenheight_(600)
        {

        }

        // Copy-constructor
        IntersectionUpdateCallback(const IntersectionUpdateCallback& nc, const osg::CopyOp& op): NodeCallback(nc, op),
            camera_(nc.camera_),
            intersectionController_(nc.intersectionController_),
            colorIndex_(nc.colorIndex_),
            screenwidth_(nc.screenwidth_),
            screenheight_(nc.screenheight_)
        {

        }

        // Updates the current reference resolution to calculate actual
        // pointer position from Leap Motion's relative position values
        // (Leap reports values from 0.0 to 1.0 for both axes, but we
        //  need absolute pixel coordinates here)
        //
        // NOTE: Setting resolution has no effect, if
        // IntersectionUpdateCallback was constructed with an osg::Camera
        // as reference.
        void setResolution(int screenwidth, int screenheight);

        virtual void operator()(osg::Node* node, osg::NodeVisitor* nv);

    private:
        osg::ref_ptr<osgLeap::IntersectionController> intersectionController_;
        osg::ref_ptr<osg::Camera> camera_;
        int colorIndex_;
        float screenheight_;
        float screenwidth_;

        osg::Vec4 getColor();

        // To alter the geometry of a pointer, subclass
        // IntersectionUpdateCallback overriding createPointerGeode
        virtual osg::ref_ptr<osg::Node> createPointerGeode();
    };

} // namespace osgLeap

#endif // OSGLEAP_INTERSECTIONUPDATECALLBACK_
